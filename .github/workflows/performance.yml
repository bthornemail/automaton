name: Performance Testing

on:
  schedule:
    - cron: '0 6 * * 0'  # Weekly on Sunday at 6 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - '**/src/**'
      - '**/package*.json'

jobs:
  load-testing:
    name: Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd ui && npm ci

      - name: Build application
        run: |
          npm run build
          cd ui && npm run build

      - name: Start application
        run: |
          npm start &
          sleep 30

      - name: Install Artillery
        run: npm install -g artillery@latest

      - name: Run load tests
        run: |
          artillery run tests/performance/load-test.yml

      - name: Upload load test results
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: artillery-report.html

  performance-budget:
    name: Performance Budget
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd ui && npm ci

      - name: Build frontend
        run: |
          cd ui && npm run build

      - name: Analyze bundle size
        uses: preactjs/compressed-size-action@v2
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          pattern: "./ui/dist/**/*.{js,css,html}"
          exclude: "{./ui/dist/**/*.map,./ui/dist/**/manifest.json}"

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run memory profiling
        run: |
          node --inspect tests/performance/memory-profiling.js &
          sleep 60
          node tests/performance/collect-memory-stats.js

      - name: Upload memory profile
        uses: actions/upload-artifact@v3
        with:
          name: memory-profile
          path: memory-profile.heapprofile

  stress-testing:
    name: Stress Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Build test environment
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 60

      - name: Install stress testing tools
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils wrk

      - name: Run stress tests
        run: |
          # Apache Bench
          ab -n 10000 -c 100 http://localhost:5555/health
          
          # wrk
          wrk -t12 -c400 -d30s http://localhost:5555/api/automaton/status
          
          # Custom stress test
          node tests/performance/stress-test.js

      - name: Cleanup test environment
        run: |
          docker-compose -f docker-compose.test.yml down

      - name: Upload stress test results
        uses: actions/upload-artifact@v3
        with:
          name: stress-test-results
          path: stress-test-results.json

  performance-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd ui && npm ci

      - name: Benchmark main branch
        run: |
          git checkout main
          npm run build
          npm run benchmark > baseline.txt

      - name: Benchmark PR branch
        run: |
          git checkout ${{ github.head_ref }}
          npm run build
          npm run benchmark > pr.txt

      - name: Compare performance
        run: |
          node tests/performance/compare-benchmarks.js baseline.txt pr.txt

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('performance-comparison.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comparison
            });

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [load-testing, performance-budget, memory-profiling, stress-testing]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate performance report
        run: |
          echo "# Performance Test Report" > performance-report.md
          echo "" >> performance-report.md
          echo "## Test Results" >> performance-report.md
          echo "" >> performance-report.md
          echo "- Load Testing: ${{ needs.load-testing.result }}" >> performance-report.md
          echo "- Performance Budget: ${{ needs.performance-budget.result }}" >> performance-report.md
          echo "- Memory Profiling: ${{ needs.memory-profiling.result }}" >> performance-report.md
          echo "- Stress Testing: ${{ needs.stress-testing.result }}" >> performance-report.md
          echo "" >> performance-report.md
          echo "Generated on: $(date)" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md