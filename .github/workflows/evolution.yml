name: Automaton Evolution

on:
  push:
    branches:
      - evolution
  workflow_dispatch:
    inputs:
      variant:
        description: 'Specific variant to build (leave empty for all)'
        required: false
        type: choice
        options:
          - all
          - llama3.2
          - gpt-oss
          - native
          - fast
          - wordnet

jobs:
  evolution:
    name: Automaton Evolution
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd meta-log-db && npm ci
          cd ../plugin/meta-log-plugin && npm ci

      - name: Build Meta-Log-Db
        run: |
          cd meta-log-db
          npm run build

      - name: Setup Meta-Log-Db
        run: |
          npm link meta-log-db
          cd meta-log-db && npm link

      - name: Run automaton evolution
        id: evolution
        run: |
          echo "ðŸš€ Starting automaton evolution..."
          
          # Start automaton with memory monitoring
          NODE_OPTIONS="--expose-gc --max-old-space-size=2048" \
          tsx automaton-memory-optimized.ts &
          AUTOMATON_PID=$!
          
          # Start memory-aware snapshot system
          tsx snapshot-automaton-memory.ts &
          SNAPSHOT_PID=$!
          
          # Run for evolution duration (configurable)
          EVOLUTION_DURATION=${EVOLUTION_DURATION:-300} # 5 minutes default
          echo "â³ Running evolution for ${EVOLUTION_DURATION} seconds..."
          sleep $EVOLUTION_DURATION
          
          # Stop processes
          kill $AUTOMATON_PID $SNAPSHOT_PID 2>/dev/null || true
          wait $AUTOMATON_PID $SNAPSHOT_PID 2>/dev/null || true
          
          echo "âœ… Evolution complete"
        env:
          EVOLUTION_DURATION: 300
          API_URL: http://localhost:5555

      - name: Analyze evolution snapshots
        run: |
          echo "ðŸ“Š Analyzing evolution snapshots..."
          tsx analyze-memory-snapshots.ts > evolution-analysis.txt || true
          tsx memory-leak-investigator.ts >> evolution-analysis.txt || true
          
          # Store analysis results
          echo "evolution_analysis<<EOF" >> $GITHUB_OUTPUT
          cat evolution-analysis.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate evolution variants
        id: variants
        run: |
          echo "ðŸ”¨ Generating evolution variants..."
          
          VARIANT_INPUT="${{ github.event.inputs.variant || 'all' }}"
          
          # Generate variants using Meta-Log-Db
          tsx scripts/generate-evolution-variants.ts \
            --input automaton.jsonl \
            --snapshots snapshots-memory \
            --variants "$VARIANT_INPUT" \
            --output-dir evolution-variants
          
          # List generated variants
          ls -la evolution-variants/
          
          # Store variant paths
          echo "variants=$(ls evolution-variants/*.canvasl | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Validate variants
        run: |
          echo "âœ… Validating evolution variants..."
          
          for variant in evolution-variants/*.canvasl; do
            echo "Validating $variant..."
            tsx validate-canvasl.ts "$variant" || exit 1
          done
          
          echo "âœ… All variants validated"

      - name: Store evolution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evolution-artifacts
          path: |
            evolution-variants/*.canvasl
            snapshots-memory/*.json
            evolution-analysis.txt
          retention-days: 30

      - name: Commit evolution variants
        if: github.ref == 'refs/heads/evolution'
        run: |
          echo "ðŸ“ Committing evolution variants..."
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Copy variants to root
          cp evolution-variants/automaton.llama3.2:latest.canvasl . || true
          cp evolution-variants/automaton.gpt-oss:20b.canvasl . || true
          cp evolution-variants/automaton.native.canvasl . || true
          cp evolution-variants/automaton.fast.canvasl . || true
          
          # Commit if changes
          git add automaton.*.canvasl || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update evolution variants [skip ci]"
            git push origin evolution || echo "Push failed (may require manual merge)"
          fi

      - name: Create evolution report
        run: |
          echo "ðŸ“„ Creating evolution report..."
          
          cat > evolution-report.md << EOF
          # Automaton Evolution Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** ${{ github.ref }}
          **Commit:** ${{ github.sha }}
          
          ## Evolution Summary
          
          \`\`\`
          ${{ steps.evolution.outputs.summary || 'No summary available' }}
          \`\`\`
          
          ## Analysis Results
          
          \`\`\`
          ${{ steps.evolution.outputs.evolution_analysis || 'No analysis available' }}
          \`\`\`
          
          ## Generated Variants
          
          ${{ steps.variants.outputs.variants || 'No variants generated' }}
          
          ## Next Steps
          
          1. Review evolution analysis
          2. Validate variant performance
          3. Merge variants to main branch if approved
          EOF
          
          cat evolution-report.md

      - name: Upload evolution report
        uses: actions/upload-artifact@v4
        with:
          name: evolution-report
          path: evolution-report.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('evolution-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
