apiVersion: v1
kind: Secret
metadata:
  name: automaton-secrets
  namespace: automaton-security
  labels:
    app.kubernetes.io/name: automaton
type: Opaque
data:
  # Base64 encoded values
  redis-password: YXV0b21hdG9uLXJlZGlzLXBhc3N3b3Jk  # automaton-redis-password
  jwt-secret: YXV0b21hdG9uLWp3dC1zZWNyZXQta2V5  # automaton-jwt-secret-key
  api-keys: eyJvcGVuYWkiOiAieW91ci1vcGVuYWkta2V5IiwgImFudGhyb3BpYyI6ICJ5b3VyLWFudGhyb3BpYy1rZXkifQ==
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: automaton-security-config
  namespace: automaton-security
  labels:
    app.kubernetes.io/name: automaton
data:
  security-policy.yaml: |
    # Security configuration
    authentication:
      enabled: true
      jwt:
        secret: ${JWT_SECRET}
        expiration: "24h"
    
    authorization:
      enabled: true
      rbac:
        enabled: true
    
    rate-limiting:
      enabled: true
      requests-per-minute: 100
    
    cors:
      enabled: true
      origins:
        - "https://automaton.example.com"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
      headers:
        - Content-Type
        - Authorization
    
    security-headers:
      x-frame-options: "DENY"
      x-content-type-options: "nosniff"
      x-xss-protection: "1; mode=block"
      strict-transport-security: "max-age=31536000; includeSubDomains"
      content-security-policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
  
  audit-policy.yaml: |
    # Audit policy
    apiVersion: audit.k8s.io/v1
    kind: Policy
    rules:
    - level: Metadata
      namespaces: ["automaton-security"]
      resources:
      - group: ""
        resources: ["secrets", "configmaps"]
      - group: "apps"
        resources: ["deployments"]
    - level: Request
      namespaces: ["automaton-security"]
      resources:
      - group: ""
        resources: ["pods"]
      verbs: ["create", "delete", "update", "patch"]
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: automaton-security-webhook
  labels:
    app.kubernetes.io/name: automaton
webhooks:
- name: security.automaton.io
  clientConfig:
    service:
      name: automaton-security-service
      namespace: automaton-security
      path: "/validate"
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["apps"]
    apiVersions: ["v1"]
    resources: ["deployments"]
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  failurePolicy: Fail
---
apiVersion: v1
kind: Service
metadata:
  name: automaton-security-service
  namespace: automaton-security
  labels:
    app.kubernetes.io/name: automaton
    app.kubernetes.io/component: security
spec:
  selector:
    app.kubernetes.io/name: automaton
    app.kubernetes.io/component: security
  ports:
  - name: https
    port: 443
    targetPort: 8443
    protocol: TCP