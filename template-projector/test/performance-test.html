<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Federation Performance Measurement</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #0a0a0a;
      color: #f0f0f0;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #1a1a1a;
    }
    .success { color: #4ECDC4; }
    .error { color: #FF6B6B; }
    .warning { color: #F7DC6F; }
    .info { color: #F7DC6F; }
    pre {
      background: #0a0a0a;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
    }
    button {
      background: #4ECDC4;
      color: #0a0a0a;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .metric-card {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #333;
    }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #4ECDC4;
    }
    .metric-label {
      color: #888;
      font-size: 0.9em;
    }
    .chart {
      background: #0f0f0f;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>⚡ Federation Performance Measurement</h1>
  
  <div class="metrics" id="metrics">
    <div class="metric-card">
      <div class="metric-value" id="avg-duration">0ms</div>
      <div class="metric-label">Average Duration</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="min-duration">0ms</div>
      <div class="metric-label">Min Duration</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="max-duration">0ms</div>
      <div class="metric-label">Max Duration</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="total-queries">0</div>
      <div class="metric-label">Total Queries</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="success-rate">0%</div>
      <div class="metric-label">Success Rate</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="network-calls">0</div>
      <div class="metric-label">Network Calls</div>
    </div>
  </div>

  <div style="margin: 20px 0;">
    <button onclick="runPerformanceTests()">Run Performance Tests</button>
    <button onclick="testWithValues()">Test VALUES Optimization</button>
    <button onclick="testWithoutValues()">Test Without VALUES</button>
    <button onclick="clearMetrics()">Clear Metrics</button>
  </div>

  <div class="test-section">
    <h2>Performance Test 1: Single SERVICE Query</h2>
    <div id="test1-result" class="info">Click "Run Performance Tests" to start</div>
  </div>

  <div class="test-section">
    <h2>Performance Test 2: Multiple SERVICE Queries</h2>
    <div id="test2-result" class="info">Waiting...</div>
  </div>

  <div class="test-section">
    <h2>Performance Test 3: VALUES Optimization Impact</h2>
    <div id="test3-result" class="info">Waiting...</div>
  </div>

  <div class="test-section">
    <h2>Performance Test 4: Query Rewriting Overhead</h2>
    <div id="test4-result" class="info">Waiting...</div>
  </div>

  <div class="test-section">
    <h2>Performance Test 5: Result Joining</h2>
    <div id="test5-result" class="info">Waiting...</div>
  </div>

  <div class="test-section">
    <h2>Performance Comparison</h2>
    <div id="comparison-result" class="info">Waiting...</div>
  </div>

  <script type="module">
    import { Projector } from '../src/projector/Projector.js';
    import { SparqlFederation } from '../src/utils/SparqlFederation.js';

    let projector;
    let federation;
    const metrics = {
      durations: [],
      networkCalls: 0,
      successes: 0,
      failures: 0
    };

    function updateMetrics() {
      if (metrics.durations.length === 0) return;

      const avg = metrics.durations.reduce((a, b) => a + b, 0) / metrics.durations.length;
      const min = Math.min(...metrics.durations);
      const max = Math.max(...metrics.durations);
      const successRate = metrics.successes / (metrics.successes + metrics.failures) * 100;

      document.getElementById('avg-duration').textContent = `${avg.toFixed(0)}ms`;
      document.getElementById('min-duration').textContent = `${min.toFixed(0)}ms`;
      document.getElementById('max-duration').textContent = `${max.toFixed(0)}ms`;
      document.getElementById('total-queries').textContent = metrics.durations.length;
      document.getElementById('success-rate').textContent = `${successRate.toFixed(1)}%`;
      document.getElementById('network-calls').textContent = metrics.networkCalls;
    }

    function clearMetrics() {
      metrics.durations = [];
      metrics.networkCalls = 0;
      metrics.successes = 0;
      metrics.failures = 0;
      updateMetrics();
    }

    async function init() {
      if (projector) return;

      projector = new Projector();
      await projector.onInit();
      
      federation = new SparqlFederation(projector.metaLog, projector.errorHandler);
      federation.registerEndpoint('https://dbpedia.org/sparql', {
        requiresConsent: false
      });
    }

    function setResult(testId, success, message, details = null) {
      const element = document.getElementById(`test-${testId}-result`);
      element.className = `test-result ${success ? 'success' : 'error'}`;
      
      let html = success ? '✅ ' : '❌ ';
      html += message;
      
      if (details) {
        html += '<pre>' + JSON.stringify(details, null, 2) + '</pre>';
      }
      
      element.innerHTML = html;
    }

    async function measureQuery(query, label) {
      await init();
      
      const startTime = performance.now();
      metrics.networkCalls++;
      
      try {
        const result = await federation.executeFederatedQuery(query);
        const duration = performance.now() - startTime;
        
        metrics.durations.push(duration);
        metrics.successes++;
        updateMetrics();
        
        return {
          success: true,
          duration,
          result,
          bindings: result.results?.bindings?.length || 0
        };
      } catch (error) {
        const duration = performance.now() - startTime;
        metrics.durations.push(duration);
        metrics.failures++;
        updateMetrics();
        
        return {
          success: false,
          duration,
          error: error.message
        };
      }
    }

    async function test1_SingleService() {
      const query = `
        PREFIX dbr: <http://dbpedia.org/resource/>
        PREFIX dbo: <http://dbpedia.org/ontology/>
        
        SELECT ?abstract WHERE {
          SERVICE <https://dbpedia.org/sparql> {
            dbr:Albert_Einstein dbo:abstract ?abstract .
            FILTER(LANG(?abstract) = "en")
          }
        }
        LIMIT 1
      `;

      const result = await measureQuery(query, 'Single SERVICE');
      const success = result.success && result.duration < 5000; // < 5 seconds
      
      setResult(1, success,
        success ? `Single SERVICE query: ${result.duration.toFixed(0)}ms` : 'Query failed or too slow',
        {
          duration: `${result.duration.toFixed(0)}ms`,
          bindings: result.bindings,
          target: '< 5000ms'
        }
      );
    }

    async function test2_MultipleServices() {
      const query = `
        PREFIX dbr: <http://dbpedia.org/resource/>
        PREFIX dbo: <http://dbpedia.org/ontology/>
        
        SELECT ?abstract ?thumbnail WHERE {
          SERVICE <https://dbpedia.org/sparql> {
            dbr:Albert_Einstein dbo:abstract ?abstract .
            FILTER(LANG(?abstract) = "en")
          }
          SERVICE <https://dbpedia.org/sparql> {
            dbr:Albert_Einstein dbo:thumbnail ?thumbnail .
          }
        }
        LIMIT 1
      `;

      const result = await measureQuery(query, 'Multiple SERVICE');
      const success = result.success && result.duration < 10000; // < 10 seconds
      
      setResult(2, success,
        success ? `Multiple SERVICE queries: ${result.duration.toFixed(0)}ms` : 'Query failed or too slow',
        {
          duration: `${result.duration.toFixed(0)}ms`,
          bindings: result.bindings,
          target: '< 10000ms'
        }
      );
    }

    async function testWithValues() {
      const query = `
        VALUES ?city { "Los_Angeles" "New_York" }
        PREFIX dbr: <http://dbpedia.org/resource/>
        PREFIX dbo: <http://dbpedia.org/ontology/>
        
        SELECT ?city ?pop WHERE {
          SERVICE <https://dbpedia.org/sparql> {
            ?city dbo:populationTotal ?pop .
          }
        }
      `;

      const result = await measureQuery(query, 'With VALUES');
      return result;
    }

    async function testWithoutValues() {
      const query = `
        PREFIX dbr: <http://dbpedia.org/resource/>
        PREFIX dbo: <http://dbpedia.org/ontology/>
        
        SELECT ?city ?pop WHERE {
          SERVICE <https://dbpedia.org/sparql> {
            { dbr:Los_Angeles dbo:populationTotal ?pop . BIND("Los_Angeles" AS ?city) }
            UNION
            { dbr:New_York dbo:populationTotal ?pop . BIND("New_York" AS ?city) }
          }
        }
      `;

      const result = await measureQuery(query, 'Without VALUES');
      return result;
    }

    async function test3_ValuesOptimization() {
      const withValues = await testWithValues();
      const withoutValues = await testWithoutValues();
      
      const improvement = withoutValues.duration - withValues.duration;
      const improvementPercent = (improvement / withoutValues.duration) * 100;
      
      const success = withValues.success && improvement > 0;
      
      setResult(3, success,
        success ? `VALUES optimization: ${improvementPercent.toFixed(1)}% faster` : 'VALUES optimization test failed',
        {
          withValues: `${withValues.duration.toFixed(0)}ms`,
          withoutValues: `${withoutValues.duration.toFixed(0)}ms`,
          improvement: `${improvement.toFixed(0)}ms (${improvementPercent.toFixed(1)}%)`
        }
      );
    }

    async function test4_QueryRewriting() {
      await init();
      
      const query = `
        VALUES ?id { "Einstein" "Newton" }
        SELECT ?id ?abstract WHERE {
          SERVICE <https://dbpedia.org/sparql> {
            ?person rdfs:label ?id ; dbo:abstract ?abstract .
          }
        }
      `;

      const startTime = performance.now();
      
      // Parse and rewrite
      const blocks = federation.parseServiceBlocks(query);
      const values = federation.extractValuesBindings(query);
      const rewritten = blocks.length > 0 ? federation.buildServiceQuery(blocks[0].query, values) : null;
      
      const duration = performance.now() - startTime;
      
      const success = rewritten && rewritten.includes('VALUES') && duration < 100; // < 100ms
      
      setResult(4, success,
        success ? `Query rewriting: ${duration.toFixed(2)}ms` : 'Query rewriting failed or too slow',
        {
          duration: `${duration.toFixed(2)}ms`,
          hasValues: rewritten?.includes('VALUES') || false,
          target: '< 100ms'
        }
      );
    }

    async function test5_ResultJoining() {
      await init();
      
      // Mock multiple SERVICE results
      federation.registerMockEndpoint('service1', async () => ({
        results: {
          bindings: [
            { id: { value: '1' }, name: { value: 'Alice' } },
            { id: { value: '2' }, name: { value: 'Bob' } }
          ]
        }
      }));

      federation.registerMockEndpoint('service2', async () => ({
        results: {
          bindings: [
            { id: { value: '1' }, age: { value: '30' } },
            { id: { value: '2' }, age: { value: '25' } }
          ]
        }
      }));

      const query = `
        SELECT ?id ?name ?age WHERE {
          SERVICE <service1> { ?id rdfs:label ?name . }
          SERVICE <service2> { ?id schema:age ?age . }
        }
      `;

      const startTime = performance.now();
      const result = await federation.executeFederatedQuery(query);
      const duration = performance.now() - startTime;
      
      const success = result.results?.bindings?.length >= 2 && duration < 50; // < 50ms for mock
      
      setResult(5, success,
        success ? `Result joining: ${duration.toFixed(2)}ms (${result.results.bindings.length} bindings)` : 'Result joining failed',
        {
          duration: `${duration.toFixed(2)}ms`,
          bindings: result.results?.bindings?.length || 0,
          target: '< 50ms (mock)'
        }
      );
    }

    async function runPerformanceTests() {
      clearMetrics();
      
      await test1_SingleService();
      await test2_MultipleServices();
      await test3_ValuesOptimization();
      await test4_QueryRewriting();
      await test5_ResultJoining();
      
      // Generate comparison
      generateComparison();
    }

    function generateComparison() {
      if (metrics.durations.length === 0) return;

      const comparison = {
        average: metrics.durations.reduce((a, b) => a + b, 0) / metrics.durations.length,
        min: Math.min(...metrics.durations),
        max: Math.max(...metrics.durations),
        p50: metrics.durations.sort((a, b) => a - b)[Math.floor(metrics.durations.length / 2)],
        p95: metrics.durations.sort((a, b) => a - b)[Math.floor(metrics.durations.length * 0.95)],
        successRate: (metrics.successes / (metrics.successes + metrics.failures)) * 100
      };

      const element = document.getElementById('comparison-result');
      element.className = 'test-result info';
      element.innerHTML = `
        <h3>Performance Summary</h3>
        <pre>${JSON.stringify(comparison, null, 2)}</pre>
        <div class="chart">
          <strong>Duration Distribution:</strong><br>
          Min: ${comparison.min.toFixed(0)}ms<br>
          P50: ${comparison.p50.toFixed(0)}ms<br>
          P95: ${comparison.p95.toFixed(0)}ms<br>
          Max: ${comparison.max.toFixed(0)}ms<br>
          Avg: ${comparison.average.toFixed(0)}ms
        </div>
      `;
    }

    // Make functions available globally
    window.runPerformanceTests = runPerformanceTests;
    window.testWithValues = testWithValues;
    window.testWithoutValues = testWithoutValues;
    window.clearMetrics = clearMetrics;
  </script>
</body>
</html>
